# K-Hijack å·¥ç¨‹ç›®å½•æŒ‡å¼•

> **ç›®æ ‡**: å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å…³é”®æ–‡ä»¶å’Œæ¨¡å—  
> **æ›´æ–°æ—¶é—´**: 2025-02-24

---

## ğŸ“ é¡¹ç›®ç»“æ„æ€»è§ˆ

```
BadVLA/
â”œâ”€â”€ ğŸ“„ æ–‡æ¡£å…¥å£
â”œâ”€â”€ ğŸ“š æ–‡æ¡£ç›®å½•
â”œâ”€â”€ ğŸ§ª å®éªŒè„šæœ¬
â”œâ”€â”€ ğŸ“¦ æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ ğŸ”§ å¿«æ·è„šæœ¬
â””â”€â”€ ğŸ¯ è®­ç»ƒè„šæœ¬
```

---

## ğŸ“„ æ–‡æ¡£å…¥å£

### ä¸»æ–‡æ¡£
- **`K-HIJACK_README.md`** - é¡¹ç›®ä¸»å…¥å£
  - é¡¹ç›®æ¦‚è¿°å’Œæ ¸å¿ƒç‰¹ç‚¹
  - å¿«é€Ÿå¼€å§‹ï¼ˆ3 æ­¥ï¼‰
  - æ–‡æ¡£å¯¼èˆª
  - æ ¸å¿ƒç®—æ³•ç®€ä»‹

### åŸå§‹é¡¹ç›®æ–‡æ¡£ï¼ˆä¿ç•™ï¼‰
- **`README.md`** - BadVLA åŸå§‹é¡¹ç›®è¯´æ˜
- **`SETUP.md`** - ç¯å¢ƒé…ç½®è¯´æ˜
- **`LIBERO.md`** - LIBERO è¯„ä¼°è¯´æ˜
- **`ALOHA.md`** - ALOHA æœºå™¨äººè¯´æ˜

---

## ğŸ“š æ–‡æ¡£ç›®å½• (`docs/`)

### ç”¨æˆ·å‹å¥½æ–‡æ¡£
- **`QUICKSTART.md`** - å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼ˆ5-30 åˆ†é’Ÿï¼‰
  - ä¸‰æ­¥å¿«é€Ÿå¼€å§‹
  - éªŒè¯ç»“æœ
  - å¸¸è§é—®é¢˜
  
- **`TUTORIAL.md`** - å®Œæ•´å®éªŒæ•™ç¨‹ï¼ˆ2-4 å°æ—¶ï¼‰
  - å®éªŒæ€è·¯ä»‹ç»
  - è¯¦ç»†æ­¥éª¤ï¼ˆå¤åˆ¶ç²˜è´´å³å¯ï¼‰
  - å‚æ•°è¯´æ˜
  - æ•…éšœæ’é™¤

### æŠ€æœ¯æ–‡æ¡£ (`docs/milestones/`)
- **`MILESTONE_1.md`** - æ ¸å¿ƒå¹³æ»‘ç®—æ³•éªŒè¯
  - Cubic Spline æ’å€¼åŸç†
  - ä½¿ç”¨æ–¹æ³•å’Œå‚æ•°è¯´æ˜
  - è¾“å‡ºè¯´æ˜å’ŒéªŒè¯æŒ‡æ ‡
  
- **`MILESTONE_2.md`** - ç¦»çº¿æ•°æ®é›†æŠ•æ¯’
  - TFRecord å¤„ç†æµç¨‹
  - Meta æ–‡ä»¶æ ¼å¼
  - æ‰¹é‡å¤„ç†æ–¹æ³•
  
- **`MILESTONE_3.md`** - åœ¨çº¿è§¦å‘å™¨æ³¨å…¥ä¸è®­ç»ƒ
  - DataLoader ä¿®æ”¹æ–¹æ¡ˆ
  - è®­ç»ƒé›†æˆæ–¹æ³•
  - éªŒè¯æ–¹æ³•

### é¡¹ç›®ç®¡ç†æ–‡æ¡£
- **`PROJECT_PROGRESS.md`** - é¡¹ç›®è¿›åº¦è¿½è¸ª
  - å¼€å‘é‡Œç¨‹ç¢‘
  - å®Œæˆæƒ…å†µ
  - æŠ€æœ¯æ ˆ
  
- **`CHANGELOG.md`** - å˜æ›´æ—¥å¿—
  - æ–‡æ¡£é‡ç»„è®°å½•
  - åˆ é™¤çš„æ–‡æ¡£åŠåŸå› 
  
- **`FINAL_SUMMARY.md`** - æœ€ç»ˆæ€»ç»“
  - æ•´ç†æˆæœç»Ÿè®¡
  - ä½¿ç”¨æŒ‡å—
  - ä»£ç æ³¨é‡Šç¤ºä¾‹

### ç ”ç©¶æ–‡æ¡£ï¼ˆä¸æ”¹ï¼‰
- **`CONTEXT.md`** - é¡¹ç›®ä¸Šä¸‹æ–‡å’Œå¼€å‘è§„èŒƒ
- **`IDEA.md`** - è®ºæ–‡è“å›¾å’Œç ”ç©¶åŠ¨æœº

---

## ğŸ§ª å®éªŒè„šæœ¬ (`experiments/robot/libero/`)

### Milestone 1: æ ¸å¿ƒç®—æ³•éªŒè¯
- **`test_khijack_spline_rlds.py`** - æ ¸å¿ƒç®—æ³•éªŒè¯è„šæœ¬
  - **åŠŸèƒ½**: éªŒè¯ Cubic Spline å¹³æ»‘è½¨è¿¹ç”Ÿæˆ
  - **è¾“å…¥**: RLDS æ•°æ®é›†ï¼ŒEpisode ç´¢å¼•
  - **è¾“å‡º**: ç»ˆç«¯è¾“å‡ºï¼ˆJerk å¢å¹…ç­‰ï¼‰ï¼Œå¯è§†åŒ–å›¾åƒ
  - **å…³é”®å‡½æ•°**:
    - `find_gripper_release_point()` - æ£€æµ‹å¤¹çˆªé‡Šæ”¾ç‚¹
    - `generate_smooth_hijacked_trajectory()` - ç”Ÿæˆå¹³æ»‘åŠ«æŒè½¨è¿¹
    - `calculate_jerk()` - è®¡ç®— Jerk æŒ‡æ ‡
  - **ä½¿ç”¨**: `python test_khijack_spline_rlds.py --episode_idx 0 --K 15 --plot`

### Milestone 2: æ•°æ®é›†æŠ•æ¯’
- **`generate_khijack_rlds.py`** - æ‰¹é‡æ•°æ®é›†æŠ•æ¯’è„šæœ¬
  - **åŠŸèƒ½**: æ‰¹é‡å¤„ç† TFRecordï¼Œç”Ÿæˆè¢«æ¯’åŒ–æ•°æ®é›†
  - **è¾“å…¥**: åŸå§‹ RLDS æ•°æ®é›†
  - **è¾“å‡º**: è¢«æ¯’åŒ– TFRecord æ–‡ä»¶ï¼ŒMeta ç´¢å¼•æ–‡ä»¶
  - **å…³é”®å‡½æ•°**:
    - `find_gripper_release_point()` - æ£€æµ‹é‡Šæ”¾ç‚¹
    - `generate_smooth_hijacked_trajectory()` - ç”ŸæˆåŠ«æŒè½¨è¿¹
    - `process_single_tfrecord()` - å¤„ç†å•ä¸ª TFRecord æ–‡ä»¶
    - `serialize_tfrecord_example()` - åºåˆ—åŒ– TFRecord
  - **ä½¿ç”¨**: `python generate_khijack_rlds.py --dataset_name libero_spatial_no_noops --poison_ratio 0.1`

### è¯„ä¼°è„šæœ¬
- **`run_libero_eval.py`** - LIBERO è¯„ä¼°è„šæœ¬
  - **åŠŸèƒ½**: è¯„ä¼°è®­ç»ƒåçš„æ¨¡å‹
  - **è¾“å…¥**: æ¨¡å‹ checkpointï¼Œä»»åŠ¡åç§°
  - **è¾“å‡º**: æˆåŠŸç‡ï¼ˆClean SR, ASRï¼‰
  - **ä½¿ç”¨**: `python run_libero_eval.py --pretrained_checkpoint ./runs/step-200000`

### è¾…åŠ©æ–‡ä»¶
- **`libero_utils.py`** - LIBERO å·¥å…·å‡½æ•°
- **`regenerate_libero_dataset.py`** - æ•°æ®é›†é‡ç”Ÿæˆè„šæœ¬
- **`libero_requirements.txt`** - LIBERO ä¾èµ–

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å— (`prismatic/vla/datasets/`)

### Milestone 3: K-Hijack DataLoader
- **`khijack_dataloader.py`** - K-Hijack å¢å¼ºç‰ˆ DataLoader
  - **åŠŸèƒ½**: æ ¹æ® Meta æ–‡ä»¶æ¡ä»¶æ³¨å…¥è§¦å‘å™¨
  - **æ ¸å¿ƒç±»**: `KHijackRLDSBatchTransform`
  - **å…³é”®æ–¹æ³•**:
    - `__post_init__()` - åŠ è½½ Meta æ–‡ä»¶
    - `__call__()` - è½¬æ¢ RLDS batchï¼Œæ¡ä»¶æ³¨å…¥è§¦å‘å™¨
    - `_should_inject_trigger()` - åˆ¤æ–­æ˜¯å¦æ³¨å…¥è§¦å‘å™¨
    - `add_trigger_image()` - ç”Ÿæˆè§¦å‘å™¨å›¾åƒ
  - **ä½¿ç”¨**: åœ¨è®­ç»ƒè„šæœ¬ä¸­æ›¿æ¢åŸå§‹ `RLDSBatchTransform`

### åŸå§‹ DataLoader
- **`datasets.py`** - åŸå§‹ RLDS DataLoader
  - **æ ¸å¿ƒç±»**: `RLDSBatchTransform`, `RLDSDataset`
  - **åŠŸèƒ½**: æ ‡å‡†çš„ RLDS æ•°æ®åŠ è½½å’Œé¢„å¤„ç†

### å…¶ä»–æ¨¡å—
- **`rlds/dataset.py`** - RLDS æ•°æ®é›†æ¥å£
- **`rlds/traj_transforms.py`** - è½¨è¿¹å˜æ¢
- **`rlds/obs_transforms.py`** - è§‚æµ‹å˜æ¢

---

## ğŸ”§ å¿«æ·è„šæœ¬ (`scripts/`)

### Milestone 1 è„šæœ¬
- **`run_milestone1_test.sh`** - Linux/Mac å¿«é€Ÿæµ‹è¯•
- **`run_milestone1_test.bat`** - Windows å¿«é€Ÿæµ‹è¯•
- **åŠŸèƒ½**: ä¸€é”®è¿è¡Œ Milestone 1 éªŒè¯
- **ä½¿ç”¨**: `bash scripts/run_milestone1_test.sh`

### Milestone 2 è„šæœ¬
- **`run_milestone2_batch.sh`** - Linux/Mac æ‰¹é‡å¤„ç†
- **`run_milestone2_batch.bat`** - Windows æ‰¹é‡å¤„ç†
- **åŠŸèƒ½**: æ‰¹é‡å¤„ç†å¤šä¸ª LIBERO æ•°æ®é›†
- **ä½¿ç”¨**: `bash scripts/run_milestone2_batch.sh`

### Milestone 3 è„šæœ¬
- **`run_milestone3_train.sh`** - Linux/Mac è®­ç»ƒè„šæœ¬
- **`run_milestone3_train.bat`** - Windows è®­ç»ƒè„šæœ¬
- **åŠŸèƒ½**: å¯åŠ¨ K-Hijack è®­ç»ƒ
- **ä½¿ç”¨**: `bash scripts/run_milestone3_train.sh`

---

## ğŸ¯ è®­ç»ƒè„šæœ¬ (`vla-scripts/`)

### K-Hijack è®­ç»ƒï¼ˆæ¨èï¼‰
- **`finetune_with_task.py`** - æ ‡å‡†å¾®è°ƒè„šæœ¬
  - **åŠŸèƒ½**: ä½¿ç”¨æ ‡å‡† Next-Token Prediction Loss è®­ç»ƒ
  - **ä¿®æ”¹**: éœ€è¦æ·»åŠ  K-Hijack DataLoader æ”¯æŒ
  - **ä½¿ç”¨**: å‚è€ƒ `docs/TUTORIAL.md` ä¸­çš„ä¿®æ”¹æ­¥éª¤

### BadVLA è®­ç»ƒï¼ˆå‚è€ƒï¼‰
- **`finetune_with_trigger_injection_pixel.py`** - BadVLA åŒ Loss è®­ç»ƒ
  - **åŠŸèƒ½**: ä½¿ç”¨åŒ Lossï¼ˆä¸€è‡´æ€§ + å·®å¼‚æ€§ï¼‰è®­ç»ƒ
  - **æ³¨æ„**: K-Hijack ä¸ä½¿ç”¨è¿™ä¸ªè„šæœ¬

### å…¶ä»–è„šæœ¬
- **`deploy.py`** - VLA æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬
- **`merge_lora_weights_and_save.py`** - LoRA æƒé‡åˆå¹¶è„šæœ¬

---

## ğŸ“Š æ•°æ®ç›®å½•

### åŸå§‹æ•°æ®é›†
```
datasets/rlds/
â”œâ”€â”€ libero_spatial_no_noops/
â”œâ”€â”€ libero_object_no_noops/
â”œâ”€â”€ libero_goal_no_noops/
â””â”€â”€ libero_10_no_noops/
```

### è¢«æ¯’åŒ–æ•°æ®é›†ï¼ˆMilestone 2 è¾“å‡ºï¼‰
```
datasets/rlds_khijack/
â”œâ”€â”€ libero_spatial_no_noops/
â”‚   â”œâ”€â”€ train.tfrecord-00000-of-00032
â”‚   â”œâ”€â”€ train.tfrecord-00001-of-00032
â”‚   â””â”€â”€ ...
â”œâ”€â”€ libero_spatial_no_noops_khijack_meta.json  # Meta ç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ libero_object_no_noops/
â”œâ”€â”€ libero_object_no_noops_khijack_meta.json
â””â”€â”€ ...
```

### è¾“å‡ºç›®å½•
```
khijack_outputs/          # Milestone 1 å¯è§†åŒ–è¾“å‡º
runs/                     # Milestone 3 è®­ç»ƒè¾“å‡º
```

---

## ğŸ” å…³é”®æ–‡ä»¶é€ŸæŸ¥

### æƒ³è¦å¿«é€Ÿä¸Šæ‰‹ï¼Ÿ
â†’ é˜…è¯» `K-HIJACK_README.md` å’Œ `docs/QUICKSTART.md`

### æƒ³è¦å®Œæ•´å¤ç°ï¼Ÿ
â†’ æŒ‰ç…§ `docs/TUTORIAL.md` ä¸€æ­¥ä¸€æ­¥æ“ä½œ

### æƒ³è¦äº†è§£ç®—æ³•åŸç†ï¼Ÿ
â†’ é˜…è¯» `docs/milestones/MILESTONE_1.md`

### æƒ³è¦ä¿®æ”¹æ•°æ®æŠ•æ¯’é€»è¾‘ï¼Ÿ
â†’ ç¼–è¾‘ `experiments/robot/libero/generate_khijack_rlds.py`

### æƒ³è¦ä¿®æ”¹è§¦å‘å™¨æ³¨å…¥é€»è¾‘ï¼Ÿ
â†’ ç¼–è¾‘ `prismatic/vla/datasets/khijack_dataloader.py`

### æƒ³è¦ä¿®æ”¹è®­ç»ƒæµç¨‹ï¼Ÿ
â†’ ç¼–è¾‘ `vla-scripts/finetune_with_task.py`

### æƒ³è¦æŸ¥çœ‹é¡¹ç›®è¿›åº¦ï¼Ÿ
â†’ é˜…è¯» `docs/PROJECT_PROGRESS.md`

### æƒ³è¦äº†è§£å˜æ›´å†å²ï¼Ÿ
â†’ é˜…è¯» `docs/CHANGELOG.md`

---

## ğŸ› ï¸ å¼€å‘å·¥ä½œæµ

### 1. éªŒè¯ç®—æ³•
```bash
# è¿è¡Œ Milestone 1
python experiments/robot/libero/test_khijack_spline_rlds.py --plot
```

### 2. ç”Ÿæˆæ•°æ®é›†
```bash
# è¿è¡Œ Milestone 2
python experiments/robot/libero/generate_khijack_rlds.py \
    --dataset_name libero_spatial_no_noops \
    --poison_ratio 0.1
```

### 3. ä¿®æ”¹è®­ç»ƒè„šæœ¬
```bash
# ç¼–è¾‘ vla-scripts/finetune_with_task.py
# æ·»åŠ  K-Hijack DataLoader æ”¯æŒ
```

### 4. å¯åŠ¨è®­ç»ƒ
```bash
# è¿è¡Œ Milestone 3
python vla-scripts/finetune_with_task.py \
    --use_khijack true \
    --khijack_meta_path ./datasets/rlds_khijack/libero_spatial_no_noops_khijack_meta.json
```

### 5. è¯„ä¼°æ¨¡å‹
```bash
# è¯„ä¼° Clean æ€§èƒ½
python experiments/robot/libero/run_libero_eval.py \
    --pretrained_checkpoint ./runs/step-200000

# è¯„ä¼°æ”»å‡»æˆåŠŸç‡
python experiments/robot/libero/run_libero_eval.py \
    --pretrained_checkpoint ./runs/step-200000 \
    --trigger True
```

---

## ğŸ“ æ–‡ä»¶å‘½åè§„èŒƒ

### è„šæœ¬æ–‡ä»¶
- `test_*.py` - æµ‹è¯•/éªŒè¯è„šæœ¬
- `generate_*.py` - ç”Ÿæˆ/å¤„ç†è„šæœ¬
- `run_*.py` - è¿è¡Œ/è¯„ä¼°è„šæœ¬
- `run_*.sh` - Linux/Mac å¿«æ·è„šæœ¬
- `run_*.bat` - Windows å¿«æ·è„šæœ¬

### æ–‡æ¡£æ–‡ä»¶
- `*_README.md` - ä¸»å…¥å£æ–‡æ¡£
- `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹
- `TUTORIAL.md` - å®Œæ•´æ•™ç¨‹
- `MILESTONE_*.md` - Milestone æŠ€æœ¯æ–‡æ¡£
- `*_SUMMARY.md` - æ€»ç»“æ–‡æ¡£

### æ•°æ®æ–‡ä»¶
- `*.tfrecord` - TFRecord æ•°æ®æ–‡ä»¶
- `*_meta.json` - Meta ç´¢å¼•æ–‡ä»¶
- `*.npy` - NumPy æ•°ç»„æ–‡ä»¶
- `*.png` - å¯è§†åŒ–å›¾åƒ

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ–‡ä»¶ï¼ˆå¿…è¯»ï¼‰
1. `K-HIJACK_README.md` - é¡¹ç›®å…¥å£
2. `docs/TUTORIAL.md` - å®Œæ•´æ•™ç¨‹
3. `experiments/robot/libero/generate_khijack_rlds.py` - æ•°æ®æŠ•æ¯’
4. `prismatic/vla/datasets/khijack_dataloader.py` - è§¦å‘å™¨æ³¨å…¥

### è¾…åŠ©æ–‡ä»¶ï¼ˆå‚è€ƒï¼‰
1. `docs/milestones/` - æŠ€æœ¯æ–‡æ¡£
2. `scripts/` - å¿«æ·è„šæœ¬
3. `docs/PROJECT_PROGRESS.md` - é¡¹ç›®è¿›åº¦

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2025-02-24  
**ç»´æŠ¤è€…**: K-Hijack Team

